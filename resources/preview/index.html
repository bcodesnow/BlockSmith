<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
  body {
    background: #1e1e1e;
    color: #d4d4d4;
    font-family: Segoe UI, sans-serif;
    font-size: 13px;
    padding: 16px;
    margin: 0;
  }
  h1, h2, h3, h4 { color: #e0e0e0; margin-top: 12px; }
  code {
    background: #333;
    padding: 2px 4px;
    font-family: Consolas, monospace;
    border-radius: 3px;
    font-size: 12px;
  }
  pre {
    background: #2a2a2a;
    padding: 10px;
    border-radius: 4px;
    margin: 8px 0;
    overflow-x: auto;
  }
  pre code { background: transparent; padding: 0; }
  a { color: #6c9bd2; }
  blockquote {
    border-left: 3px solid #555;
    padding-left: 8px;
    color: #aaa;
    margin: 8px 0;
  }
  table { border-collapse: collapse; margin: 8px 0; width: 100%; }
  th, td { border: 1px solid #555; padding: 6px 10px; text-align: left; }
  th { background: #333; color: #e0e0e0; font-weight: bold; }
  tr:nth-child(even) { background: #2a2a2a; }
  hr { border: none; border-top: 1px solid #555; margin: 16px 0; }
  img { max-width: 100%; height: auto; border-radius: 4px; }
  ul, ol { padding-left: 24px; margin: 6px 0; }
  li { margin: 3px 0; }
  .mermaid-container { margin: 8px 0; }
  .mermaid-container svg { max-width: 100%; }
  .mermaid-error {
    color: #e06060;
    font-family: Consolas, monospace;
    font-size: 12px;
    white-space: pre-wrap;
    background: #2a2a2a;
    padding: 10px;
    border-radius: 4px;
    border-left: 3px solid #e06060;
  }
  /* Checkbox styling */
  input[type="checkbox"] { margin-right: 4px; }
  /* Dark scrollbar matching Qt editor pane */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #1e1e1e; }
  ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #666; }
  ::-webkit-scrollbar-corner { background: #1e1e1e; }
</style>
<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script src="mermaid.min.js"></script>
<script>
  mermaid.initialize({ startOnLoad: false, theme: 'dark' });
  var renderCounter = 0;
  var bridge = null;
  var isSyncing = false;
  var scrollTimeout = null;

  // --- WebChannel setup (deferred until transport is ready) ---
  function initBridge() {
      try {
          new QWebChannel(qt.webChannelTransport, function(channel) {
              bridge = channel.objects.scrollBridge;
          });
      } catch(e) {
          // Transport not ready yet — retry in 200ms
          setTimeout(initBridge, 200);
      }
  }
  if (typeof qt !== 'undefined' && qt.webChannelTransport) {
      initBridge();
  } else {
      // Wait for transport to become available
      var waitForQt = setInterval(function() {
          if (typeof qt !== 'undefined' && qt.webChannelTransport) {
              clearInterval(waitForQt);
              initBridge();
          }
      }, 100);
  }

  // --- Suppress shortcuts that the Qt host app handles ---
  document.addEventListener('keydown', function(e) {
      // Let Chromium handle basic text nav (arrows, home, end, page up/down)
      // Suppress Ctrl+<key> combos that the Qt app needs:
      //   Ctrl+F (find), Ctrl+H (replace), Ctrl+S (save), Ctrl+E (view toggle),
      //   Ctrl+P (quick switcher), Ctrl+W (close), Ctrl+R (reload),
      //   Ctrl+Shift+F (global search), Ctrl+Shift+S (scan), Ctrl+Shift+E (export)
      if (e.ctrlKey && !e.altKey) {
          var key = e.key.toLowerCase();
          if ('fhsewrp0'.indexOf(key) >= 0 || key === '=' || key === '+' || key === '-') {
              e.preventDefault();
              e.stopPropagation();
              return false;
          }
      }
  }, true);  // capture phase — runs before Chromium's handlers

  // --- Scroll event: preview -> editor (debounced 50ms) ---
  window.addEventListener('scroll', function() {
      if (isSyncing) return;
      if (scrollTimeout) clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(function() {
          if (!bridge) return;
          var maxY = document.documentElement.scrollHeight - window.innerHeight;
          var pct = maxY > 0 ? (window.scrollY / maxY) : 0;
          bridge.onPreviewScroll(pct);
      }, 50);
  });

  // --- Content update ---
  function updateContent(html) {
    document.getElementById('content').innerHTML = html;
    renderMermaidBlocks();
    attachHeadingClickHandlers();
  }

  function renderMermaidBlocks() {
    var blocks = document.querySelectorAll('pre code.language-mermaid');
    blocks.forEach(function(block) {
      var pre = block.parentElement;
      var source = block.textContent;
      renderCounter++;
      try {
        mermaid.render('mermaid-' + renderCounter, source).then(function(result) {
          var div = document.createElement('div');
          div.className = 'mermaid-container';
          div.innerHTML = result.svg;
          pre.replaceWith(div);
        }).catch(function(e) {
          var div = document.createElement('div');
          div.className = 'mermaid-error';
          div.textContent = 'Mermaid error: ' + e.message;
          pre.replaceWith(div);
        });
      } catch (e) {
        var div = document.createElement('div');
        div.className = 'mermaid-error';
        div.textContent = 'Mermaid error: ' + e.message;
        pre.replaceWith(div);
      }
    });
  }

  // --- Called from QML: editor -> preview (percentage-based) ---
  function scrollToPercent(pct) {
    isSyncing = true;
    var maxY = document.documentElement.scrollHeight - window.innerHeight;
    window.scrollTo(0, Math.max(0, pct * maxY));
    setTimeout(function() { isSyncing = false; }, 100);
  }

  // --- Line-based scroll (for cursor sync, future data-source-line support) ---
  function scrollToLine(lineNum) {
    isSyncing = true;
    var el = document.querySelector('[data-source-line="' + lineNum + '"]');
    if (!el) {
        // Find nearest element with data-source-line <= lineNum
        var all = document.querySelectorAll('[data-source-line]');
        var best = null;
        for (var i = 0; i < all.length; i++) {
            var ln = parseInt(all[i].getAttribute('data-source-line'));
            if (ln <= lineNum) best = all[i];
            else break;
        }
        el = best;
    }
    if (el) {
        el.scrollIntoView({ behavior: 'auto', block: 'start' });
    }
    setTimeout(function() { isSyncing = false; }, 100);
  }

  // --- Heading click handlers (Phase 5) ---
  function attachHeadingClickHandlers() {
    var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
    headings.forEach(function(h) {
        h.style.cursor = 'pointer';
        h.addEventListener('click', function(e) {
            if (!bridge) return;
            var lineNum = parseInt(h.getAttribute('data-source-line')) || 0;
            var text = h.textContent.trim();
            bridge.onHeadingClicked(lineNum, text);
            e.preventDefault();
        });
    });
  }
</script>
</head>
<body>
<div id="content"></div>
</body>
</html>
